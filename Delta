
SELECT c.*, b.data_sufficiency
FROM (
    SELECT {select_string}
    FROM `{project_id}.{dataset}.{table_name}`
    LIMIT 50000
) AS c
LEFT JOIN (
    SELECT 
        a.year_month AS yearmonth,
        CASE 
            WHEN a.year_month = (SELECT MIN(year_month) FROM (
                SELECT year_month
                FROM `{project_id}.{dataset}.{table_name}`
                GROUP BY year_month
            )) THEN 0  -- Oldest month gets 0
            WHEN SUM(a.acc_count) OVER (ORDER BY a.year_month DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) <= 50000 
            THEN 1 
            ELSE 0 
        END AS data_sufficiency
    FROM (
        SELECT year_month, COUNT(*) AS acc_count
        FROM `{project_id}.{dataset}.{table_name}`
        GROUP BY year_month
    ) a
) AS b
ON b.yearmonth = c.year_month;
